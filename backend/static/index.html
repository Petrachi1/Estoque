<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <meta name="theme-color" content="#2E7D32" />
    <title>Petrachi — Estoque & Agrofit</title>

    <!-- PWA (via /static) -->
    <link rel="manifest" href="/static/manifest.json" />
    <script src="/static/service-worker.js"></script>
    <link rel="icon" href="/static/icon-192.png" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- Alpine.js for dynamic UI -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <style>
      :root {
        --cream: #F7F0D9;
        --red: #C51D1D;
        --green: #4BA64C;
        --green-dark: #2E7D32;
        --ink: #1f2937; /* Um cinza mais suave que o preto puro */
      }
      html {
        scroll-behavior: smooth;
      }
      body {
        background-color: #f8fafc; /* Fundo cinza claro */
        color: var(--ink );
        font-family: 'Inter', sans-serif; /* Fonte mais moderna */
      }
      input, button {
        touch-action: manipulation;
      }
      .container {
        max-width: 1100px;
      }
      [x-cloak] { display: none !important; }
      .card-enter {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.3s ease, transform 0.3s ease;
      }
      .card-enter-active {
        opacity: 1;
        transform: translateY(0);
      }
    </style>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body x-data="app( )" x-init="init()">
    <div id="app" class="min-h-screen">
        <!-- HEADER -->
        <header class="sticky top-0 z-40 bg-white/80 backdrop-blur-lg border-b border-gray-200 shadow-sm">
            <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img src="https://i.imgur.com/mANQq50.png" alt="logo Petrachi" class="h-10 w-auto object-contain">
                    <div>
                        <h1 class="text-lg font-bold text-gray-800 leading-tight">Estoque & Agrofit</h1>
                        <p class="text-xs text-gray-500">Busca inteligente de defensivos</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <span id="badgeOnline" class="text-xs px-3 py-1 rounded-full font-medium"></span>
                    <button id="btnSync" class="text-sm px-4 py-2 rounded-lg bg-[var(--red )] text-white hover:bg-[var(--red)]/90 transition-colors font-semibold flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 20v-5h-5M4 4l16 16" /></svg>
                        Sincronizar
                    </button>
                </div>
            </div>
        </header>

        <!-- CONTEÚDO -->
        <main class="container mx-auto px-4 py-6">
            <!-- CONTROLES -->
            <section class="mb-6 p-5 bg-white rounded-2xl border border-gray-200 shadow-sm">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="relative col-span-1 md:col-span-3">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        <input id="qNome" type="search" placeholder="Buscar por nome comercial…" class="w-full border border-gray-300 rounded-lg pl-10 pr-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-[var(--green )] transition">
                    </div>
                    <input id="qIA" type="text" placeholder="Ingrediente ativo (ex: glifosato)" class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-[var(--green)] transition">
                    <input id="qPraga" type="text" placeholder="Praga (ex: buva)" class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-[var(--green)] transition">
                </div>
                <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-200">
                    <div class="flex items-center gap-2">
                        <button id="btnLimparFiltros" class="text-sm px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 border border-gray-300 transition-colors">Limpar filtros</button>
                        <label class="inline-flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
                            <input id="chkSomenteComRegistro" type="checkbox" class="rounded text-[var(--green)] focus:ring-[var(--green)] scale-110" checked>
                            Somente com registro válido
                        </label>
                    </div>
                    <div class="flex flex-wrap items-center gap-2 text-xs">
                        <label class="px-3 py-2 rounded-lg bg-white border border-gray-300 cursor-pointer hover:bg-gray-50 transition-colors">
                            Importar Estoque
                            <input id="fileEstoque" type="file" accept=".csv,.xlsx" class="hidden">
                        </label>
                        <label class="px-3 py-2 rounded-lg bg-white border-gray-300 cursor-pointer hover:bg-gray-50 transition-colors">
                            Importar Catálogo
                            <input id="fileCatalogo" type="file" accept=".csv,.json" class="hidden">
                        </label>
                    </div>
                </div>
            </section>

            <!-- TABS & RESULTADOS -->
            <section>
                <header class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2 p-1 bg-gray-100 rounded-lg border">
                        <button id="tabEstoque" class="px-4 py-2 rounded-md text-sm font-semibold transition-colors"></button>
                        <button id="tabFora" class="px-4 py-2 rounded-md text-sm font-semibold transition-colors"></button>
                    </div>
                    <div class="text-sm text-gray-500" id="resumoContagem">—</div>
                </header>

                <div id="lista" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                <div id="vazio" class="hidden text-center py-16 px-6 bg-white rounded-2xl border border-gray-200">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">Nenhum item encontrado</h3>
                    <p class="mt-1 text-sm text-gray-500">Tente ajustar seus filtros de busca.</p>
                </div>
                <div id="loading" class="hidden text-sm text-gray-600 flex items-center justify-center gap-2 py-16">
                    <svg class="animate-spin h-5 w-5 text-[var(--green)]" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" d="M4 12a8 8 0 018-8" fill="currentColor"></path></svg>
                    Carregando…
                </div>
            </section>
        </main>

        <!-- TOAST -->
        <div id="toast" x-show="toast.visible" x-cloak
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-y-2"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             x-transition:leave="transition ease-in duration-300"
             x-transition:leave-start="opacity-100 transform translate-y-0"
             x-transition:leave-end="opacity-0 transform translate-y-2"
             class="fixed bottom-6 left-1/2 -translate-x-1/2 px-5 py-3 rounded-xl text-white shadow-lg text-sm font-semibold"
             :class="toast.ok ? 'bg-[var(--green-dark)]' : 'bg-[var(--red)]'"
             x-text="toast.message">
        </div>
    </div>

    <script>
        function app() {
            return {
                // --- STATE ---
                tab: 'ESTOQUE',
                estoque: [],
                catalogo: [],
                filtros: { nome: '', ia: '', praga: '', somenteRegistroValido: true },
                toast: { visible: false, message: '', ok: true },
                lastETag: null,

                // --- INIT ---
                init() {
                    this.setOnlineBadge();
                    window.addEventListener('online', () => this.setOnlineBadge());
                    window.addEventListener('offline', () => this.setOnlineBadge());

                    this.loadAll();
                    this.$nextTick(() => {
                        this.updateFiltroInputs();
                        this.setActiveTab(this.tab);
                        this.tickEstoque();
                        setInterval(() => this.tickEstoque(), 30000);
                    });

                    // Event listeners for non-alpine elements
                    this.setupEventListeners();
                },

                // --- UI METHODS ---
                setOnlineBadge() {
                    const el = document.getElementById('badgeOnline');
                    if (!el) return;
                    const on = navigator.onLine;
                    el.textContent = on ? 'Online' : 'Offline';
                    el.className = `text-xs px-3 py-1 rounded-full font-medium ${on ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`;
                },

                showToast(msg, ok = true) {
                    this.toast.message = msg;
                    this.toast.ok = ok;
                    this.toast.visible = true;
                    setTimeout(() => this.toast.visible = false, 2500);
                },

                setActiveTab(newTab) {
                    this.tab = newTab;
                    const tabEstoque = document.getElementById('tabEstoque');
                    const tabFora = document.getElementById('tabFora');
                    
                    tabEstoque.textContent = `Em Estoque (${this.getEstoqueFiltrado().length})`;
                    tabFora.textContent = `Fora de Estoque (${this.getForaDoEstoqueFiltrado().length})`;

                    tabEstoque.className = `px-4 py-2 rounded-md text-sm font-semibold transition-colors ${newTab === 'ESTOQUE' ? 'bg-white text-[var(--green-dark)] shadow-sm' : 'bg-transparent text-gray-600 hover:bg-gray-200'}`;
                    tabFora.className = `px-4 py-2 rounded-md text-sm font-semibold transition-colors ${newTab === 'FORA' ? 'bg-white text-[var(--green-dark)] shadow-sm' : 'bg-transparent text-gray-600 hover:bg-gray-200'}`;
                    
                    this.renderLista();
                },

                updateFiltroInputs() {
                    document.getElementById('qNome').value = this.filtros.nome || '';
                    document.getElementById('qIA').value = this.filtros.ia || '';
                    document.getElementById('qPraga').value = this.filtros.praga || '';
                    document.getElementById('chkSomenteComRegistro').checked = !!this.filtros.somenteRegistroValido;
                },

                // --- DATA & FILTERING ---
                itemMatchesFilters(item) {
                    const f = this.filtros;
                    if (f.nome && !this.matchFuzzy(f.nome, item.nome || '')) return false;
                    if (f.ia) {
                        const listIA = String(item.ia || '').split(/[,;|]/).map(s => s.trim()).filter(Boolean);
                        if (!listIA.some(x => this.matchFuzzy(f.ia, x))) return false;
                    }
                    if (f.praga) {
                        const listP = String(item.pragas || '').split(/[,;|]/).map(s => s.trim()).filter(Boolean);
                        if (!listP.some(x => this.matchFuzzy(f.praga, x))) return false;
                    }
                    if (f.somenteRegistroValido && !String(item.registro || '').trim()) return false;
                    return true;
                },

                getEstoqueFiltrado() {
                    return this.estoque.filter(item => this.itemMatchesFilters(item));
                },

                getForaDoEstoqueFiltrado() {
                    const nomesEstoque = new Set(this.estoque.map(x => this.normalize(x.nome)));
                    return this.catalogo.filter(c => !nomesEstoque.has(this.normalize(c.nome)) && this.itemMatchesFilters(c));
                },

                // --- RENDER ---
                renderLista() {
                    const grid = document.getElementById('lista');
                    const vazio = document.getElementById('vazio');
                    const resumo = document.getElementById('resumoContagem');
                    
                    const data = this.tab === 'ESTOQUE' ? this.getEstoqueFiltrado() : this.getForaDoEstoqueFiltrado();

                    grid.innerHTML = '';
                    if (!data.length) {
                        vazio.classList.remove('hidden');
                        resumo.textContent = '0 itens';
                        return;
                    }
                    vazio.classList.add('hidden');

                    const totals = this.totaisPorUnidade(data);
                    const totaisStr = Object.entries(totals).map(([u, v]) => `${this.fmtQtd(v)} ${u}`).join(' · ');
                    resumo.textContent = `${data.length} item(ns) — ${totaisStr}`;

                    data.sort((a, b) => (b.qtd || 0) - (a.qtd || 0));

                    data.forEach((item, index) => {
                        const card = this.createCardElement(item);
                        grid.appendChild(card);
                        // Animação de entrada
                        setTimeout(() => card.classList.add('card-enter-active'), index * 50);
                    });
                },

                createCardElement(item) {
                    const card = document.createElement('div');
                    card.className = "card-enter bg-white rounded-xl border border-gray-200 shadow-sm p-4 flex flex-col justify-between transition-all hover:shadow-md hover:border-[var(--green)]";
                    
                    const und = (item.und || "").toUpperCase();
                    const badgeColor = ['L', 'ML', 'GL'].includes(und) ? 'bg-sky-100 text-sky-800' : ['KG', 'G'].includes(und) ? 'bg-amber-100 text-amber-800' : '';

                    card.innerHTML = `
                        <div>
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-base text-gray-800 pr-2">${item.nome || '—'}</h3>
                                ${this.tab === 'ESTOQUE' ? `
                                <div class="text-right flex-shrink-0">
                                    <div class="text-2xl font-extrabold text-[var(--green-dark)] leading-none">${this.fmtQtd(item.qtd || 0)}</div>
                                    <div class="text-sm font-semibold text-gray-500">${und}</div>
                                </div>
                                ` : ''}
                            </div>
                            <div class="mt-2 flex flex-wrap gap-1.5 text-xs">
                                ${item.ia ? `<span class="px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-800 border border-emerald-200">IA: ${item.ia}</span>` : ''}
                                ${item.formulacao ? `<span class="px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 border">${item.formulacao}</span>` : ''}
                                ${item.registro ? `<span class="px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 border">Reg: ${item.registro}</span>` : ''}
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-200 flex justify-between items-center">
                            <div class="text-xs text-gray-500">${item.empresa || 'Empresa não informada'}</div>
                            ${this.tab === 'FORA' ? `<button class="px-3 py-1 text-xs rounded-md border bg-gray-50 hover:bg-gray-100">Marcar p/ comprar</button>` : ''}
                        </div>
                    `;
                    return card;
                },

                // --- STORAGE ---
                saveAll() {
                    localStorage.setItem("petrachi_estoque_v1", JSON.stringify(this.estoque));
                    localStorage.setItem("petrachi_catalogo_v1", JSON.stringify(this.catalogo));
                    localStorage.setItem("petrachi_filtros_v1", JSON.stringify(this.filtros));
                },
                loadAll() {
                    try { this.estoque = JSON.parse(localStorage.getItem("petrachi_estoque_v1") || "[]"); } catch {}
                    try { this.catalogo = JSON.parse(localStorage.getItem("petrachi_catalogo_v1") || "[]"); } catch {}
                    try { this.filtros = { ...this.filtros, ...JSON.parse(localStorage.getItem("petrachi_filtros_v1") || '{}') }; } catch {}
                },

                // --- SYNC & API ---
                async doSync() {
                    document.getElementById('loading').classList.remove('hidden');
                    try {
                        const BASE_URL = "https://estoque-ji6s.onrender.com";
                        const resEst = await fetch(`${BASE_URL}/api/estoque`, { cache: "no-store" } );
                        if (!resEst.ok && resEst.status !== 304) throw new Error(`Estoque HTTP ${resEst.status}`);
                        if (resEst.status !== 304) {
                            const data = await resEst.json();
                            this.estoque = (Array.isArray(data) ? data : data.rows || []).map(this.mapFields).filter(x => x.nome);
                        }
                        const resCat = await fetch(`${BASE_URL}/api/catalogo`, { cache: "no-store" });
                        if (resCat.ok) {
                            const j2 = await resCat.json();
                            this.catalogo = (Array.isArray(j2) ? j2 : j2.rows || []).map(this.mapFields).filter(x => x.nome);
                        }
                        this.saveAll();
                        this.setActiveTab(this.tab);
                        this.showToast(`Sincronizado: ${this.estoque.length} em estoque, ${this.catalogo.length} no catálogo`);
                    } catch (e) {
                        console.error(e);
                        this.showToast("Falha na sincronização", false);
                    } finally {
                        document.getElementById('loading').classList.add('hidden');
                    }
                },

                async tickEstoque() {
                    try {
                        const BASE_URL = "https://estoque-ji6s.onrender.com";
                        const headers = this.lastETag ? { "If-None-Match": `"${this.lastETag}"` } : {};
                        const res = await fetch(`${BASE_URL}/api/estoque`, { headers, cache: "no-store" } );
                        if (res.status === 304) return;
                        if (!res.ok) throw new Error("HTTP " + res.status);
                        const et = res.headers.get("ETag");
                        if (et) this.lastETag = et.replace(/"/g, "");
                        const data = await res.json();
                        this.estoque = (Array.isArray(data) ? data : data.rows || []).map(this.mapFields).filter(x => x.nome);
                        this.saveAll();
                        if (this.tab === 'ESTOQUE') this.setActiveTab('ESTOQUE');
                    } catch (e) {
                        console.warn("tickEstoque:", e);
                    }
                },

                // --- FILE HANDLING ---
                async handleFileUpload(event, type) {
                    const file = event.target.files?.[0];
                    if (!file) return;
                    document.getElementById('loading').classList.remove('hidden');
                    try {
                        let rows = [];
                        if (file.name.toLowerCase().endsWith('.xlsx')) {
                            const buf = await file.arrayBuffer();
                            rows = this.parseXLSX(buf);
                        } else {
                            const txt = await file.text();
                            rows = file.name.toLowerCase().endsWith('.json') ? JSON.parse(txt) : this.parseCSV(txt);
                        }
                        
                        const mappedData = rows.map(this.mapFields).filter(x => x.nome);

                        if (type === 'estoque') {
                            this.estoque = mappedData;
                            this.saveAll();
                            this.setActiveTab('ESTOQUE');
                            this.showToast(`Estoque importado: ${this.estoque.length} itens`);
                        } else { // catalogo
                            this.catalogo = mappedData;
                            this.saveAll();
                            this.setActiveTab(this.tab); // Refresh counts
                            this.showToast(`Catálogo importado: ${this.catalogo.length} itens`);
                        }
                    } catch (e) {
                        console.error(e);
                        this.showToast(`Falha ao ler ${type}`, false);
                    } finally {
                        document.getElementById('loading').classList.add('hidden');
                        event.target.value = ''; // Reset file input
                    }
                },

                // --- HELPERS (unchanged logic) ---
                fmtQtd(x) {
                    if (x == null || isNaN(x)) return "0";
                    const r = Math.round((Number(x) + Number.EPSILON) * 1000) / 1000;
                    return r.toLocaleString("pt-BR", { minimumFractionDigits: 0, maximumFractionDigits: 3 });
                },
                normalize(s) {
                    if (!s) return "";
                    return String(s).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[-_/]/g, " ").replace(/[^a-z0-9% ]/g, "").replace(/\s+/g, " ").trim();
                },
                matchFuzzy(needle, hay) {
                    const n = this.normalize(needle), h = this.normalize(hay);
                    if (!n) return true;
                    return h.includes(n);
                },
                parseCSV(text) {
                    const sep = text.includes(';') ? ';' : ',';
                    const lines = text.split(/\r?\n/).filter(Boolean);
                    if (!lines.length) return [];
                    const header = lines[0].split(sep).map(s => s.trim());
                    return lines.slice(1).map(ln => {
                        const cols = ln.split(sep);
                        return header.reduce((obj, h, i) => ({ ...obj, [h]: (cols[i] ?? '').trim() }), {});
                    });
                },
                parseXLSX(arrayBuffer) {
                    const wb = XLSX.read(arrayBuffer, { type: "array" });
                    return XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: "" });
                },
                mapFields(row) {
                    const get = (keys, def = "") => {
                        for (const k of keys) if (row[k] != null && row[k] !== '') return String(row[k]).trim();
                        return def;
                    };
                    const num = (s) => {
                        const f = parseFloat(String(s ?? "").replace(",", "."));
                        return Number.isFinite(f) ? f : 0;
                    };
                    return {
                        nome: get(["nome_comercial", "Nome Comercial", "nome", "Produto", "produto"]),
                        qtd: num(get(["quantidade", "qtd", "estoque", "saldo"], "0")),
                        und: get(["unidade", "un", "und", "u.m."]),
                        ia: get(["ia", "ingrediente_ativo", "ingrediente ativo", "IAs"]),
                        pragas: get(["pragas", "praga", "alvos", "pragas_alvo"]),
                        registro: get(["registro", "numero_registro", "n_registro", "Nº Registro"]),
                        empresa: get(["empresa", "titular_registro", "registrante"]),
                        formulacao: get(["formulacao", "formulação", "form"]),
                    };
                },
                totaisPorUnidade(data) {
                    return data.reduce((acc, item) => {
                        const und = (item.und || 'un').toUpperCase();
                        acc[und] = (acc[und] || 0) + (item.qtd || 0);
                        return acc;
                    }, {});
                },

                // --- EVENT LISTENERS SETUP ---
                setupEventListeners() {
                    document.getElementById('tabEstoque').onclick = () => this.setActiveTab('ESTOQUE');
                    document.getElementById('tabFora').onclick = () => this.setActiveTab('FORA');
                    document.getElementById('btnSync').onclick = () => this.doSync();

                    document.getElementById('qNome').addEventListener('input', (e) => { this.filtros.nome = e.target.value.trim(); this.renderLista(); });
                    document.getElementById('qIA').addEventListener('input', (e) => { this.filtros.ia = e.target.value.trim(); this.renderLista(); });
                    document.getElementById('qPraga').addEventListener('input', (e) => { this.filtros.praga = e.target.value.trim(); this.renderLista(); });

                    document.getElementById('btnLimparFiltros').onclick = () => {
                        this.filtros = { nome: '', ia: '', praga: '', somenteRegistroValido: true };
                        this.updateFiltroInputs();
                        this.renderLista();
                        this.saveAll();
                    };
                    document.getElementById('chkSomenteComRegistro').onchange = (e) => {
                        this.filtros.somenteRegistroValido = !!e.target.checked;
                        this.renderLista();
                        this.saveAll();
                    };

                    document.getElementById('fileEstoque').addEventListener('change', (e) => this.handleFileUpload(e, 'estoque'));
                    document.getElementById('fileCatalogo').addEventListener('change', (e) => this.handleFileUpload(e, 'catalogo'));
                }
            }
        }

        // PWA
        if ("serviceWorker" in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register("/static/service-worker.js");
            });
        }
    </script>
</body>
</html>
