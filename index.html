<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" href="/icon-192.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="theme-color" content="#047857" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Petrachi — Estoque & Agrofit (Offline)</title>
    <link rel="stylesheet" href="/styles.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- XLSX parser (SheetJS) para ler .xlsx no navegador -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  </head>

    <!-- APP WRAPPER -->
    <div id="app" class="min-h-screen">
      <!-- HEADER FIXO -->
      <header class="sticky top-0 z-40 border-b border-gray-200 bg-gradient-to-r from-emerald-700 to-emerald-600 text-white">
        <div class="max-w-[1400px] mx-auto px-6 py-3 flex items-center justify-between">
          <div class="flex items-center gap-4">
            <img src="https://i.imgur.com/mANQq50.png" alt="logo Petrachi" class="h-16 w-auto object-contain drop-shadow-md" />
            <div>
              <h1 class="text-2xl font-extrabold leading-tight">Estoque & Agrofit</h1>
              <p class="text-xs/5 opacity-90">Offline-first • Filtros por IA & praga • Aba "fora do estoque"</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <span id="badgeOnline" class="text-xs px-3 py-1 rounded-full border border-white/40 bg-white/10 backdrop-blur-md">Online</span>
            <button id="btnSync" class="text-sm px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 border border-white/30">Sincronizar</button>
          </div>
        </div>
      </header>

      <!-- CONTEÚDO -->
      <main class="max-w-[1400px] mx-auto px-6 py-6">
        <!-- STEP INDICATOR (fixo só por estética/consistência com seu layout) -->
        <nav class="mb-6">
          <ol class="flex items-center gap-3 text-xs text-gray-600">
            <li class="flex items-center gap-2">
              <span class="size-6 grid place-items-center rounded-full bg-emerald-600 text-white font-semibold">1</span>
              Estoque
            </li>
            <li class="text-gray-400">›</li>
            <li class="flex items-center gap-2 opacity-70">
              <span class="size-6 grid place-items-center rounded-full bg-gray-200 font-semibold">2</span>
              Catálogo (fora do estoque)
            </li>
          </ol>
        </nav>

        <!-- CONTROLES GERAIS -->
        <section class="mb-4">
          <div class="flex flex-wrap items-center gap-3">
            <div class="relative min-w-[320px] flex-1">
              <input id="qNome" type="search" inputmode="search" placeholder="Buscar por nome comercial…" class="w-full border border-gray-300 rounded-xl pl-4 pr-24 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-300" />
              <button id="btnLimparNome" class="absolute right-2 top-1/2 -translate-y-1/2 text-sm px-3 py-1 rounded-lg bg-gray-100 hover:bg-gray-200 border border-gray-300">Limpar</button>
            </div>
            <input id="qIA" type="text" placeholder="Ingrediente ativo (ex.: difenoconazol)" class="min-w-[280px] border border-gray-300 rounded-xl px-3 py-2 focus:ring-2 focus:ring-emerald-300" />
            <input id="qPraga" type="text" placeholder="Praga (ex.: mosca branca)" class="min-w-[260px] border border-gray-300 rounded-xl px-3 py-2 focus:ring-2 focus:ring-emerald-300" />
            <button id="btnLimparFiltros" class="text-sm px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 border border-gray-300">Limpar filtros</button>
            <label class="ml-auto inline-flex items-center gap-2 text-sm">
              <input id="chkSomenteComRegistro" type="checkbox" class="scale-125" checked /> Somente itens com registro válido
            </label>
          </div>
        </section>

        <!-- AÇÕES DE DADOS (import/export) -->
        <section class="mb-6">
          <div class="flex flex-wrap items-center gap-3 text-sm">
            <label class="px-3 py-2 rounded-lg bg-white border border-gray-300 cursor-pointer hover:bg-gray-50">
              Importar ESTOQUE (.csv/.xlsx)
              <input id="fileEstoque" type="file" accept=".csv,.xlsx" class="hidden" />
            </label>
            <label class="px-3 py-2 rounded-lg bg-white border border-gray-300 cursor-pointer hover:bg-gray-50">
              Importar CATÁLOGO (.csv/.json)
              <input id="fileCatalogo" type="file" accept=".csv,.json" class="hidden" />
            </label>
            <button id="btnExportar" class="px-3 py-2 rounded-lg bg-white border border-gray-300 hover:bg-gray-50">Exportar filtros (JSON)</button>
            <span id="chipPend" class="hidden text-xs px-2 py-1 rounded-full border border-amber-300 bg-amber-50 text-amber-900 ml-2"></span>
          </div>
        </section>

        <!-- TABS -->
        <section class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
          <header class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <div class="flex items-center gap-2">
              <button id="tabEstoque" class="px-4 py-2 rounded-lg font-semibold bg-emerald-600 text-white">Estoque atual</button>
              <button id="tabFora" class="px-4 py-2 rounded-lg font-semibold bg-gray-100 border">Fora do estoque</button>
            </div>
            <div class="text-xs text-gray-500"><span id="resumoContagem">—</span></div>
          </header>

          <div class="p-6">
            <!-- LISTA -->
            <div id="lista" class="grid grid-cols-2 xl:grid-cols-4 gap-4"></div>
            <div id="vazio" class="hidden text-sm text-gray-500">Nenhum item encontrado.</div>
            <div id="loading" class="hidden text-sm text-gray-600 flex items-center gap-2"><svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" d="M4 12a8 8 0 018-8" fill="currentColor"></path></svg>Carregando…</div>
          </div>
        </section>

        <!-- TOAST -->
        <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 hidden px-4 py-3 rounded-xl text-white shadow-lg"></div>
      </main>
    </div>

    <script>
      // ===================== CONFIG & ESTADO =====================
      const STORAGE_KEY = "petrachi_estoque_v1";
      const STORAGE_CAT = "petrachi_catalogo_v1";
      const STORAGE_FILTROS = "petrachi_filtros_v1";

      const state = {
        tab: "ESTOQUE", // ESTOQUE | FORA
        estoque: [], // itens que você TEM
        catalogo: [], // todos os produtos agrofit
        filtros: {
          nome: "",
          ia: "",
          praga: "",
          somenteRegistroValido: true,
        },
      };

      const $ = (s) => document.querySelector(s);
      const $$ = (s) => document.querySelectorAll(s);

      // ===================== UI BÁSICA =====================
      function setOnlineBadge() {
        const el = $("#badgeOnline");
        const on = navigator.onLine;
        el.textContent = on ? "Online" : "Offline";
        el.className = `text-xs px-3 py-1 rounded-full border ${on ? "border-white/40 bg-white/10" : "border-yellow-300 bg-yellow-100 text-yellow-900"} backdrop-blur-sm`;
      }
      window.addEventListener("online", setOnlineBadge);
      window.addEventListener("offline", setOnlineBadge);

      function toast(msg, ok = true) {
        const el = $("#toast");
        el.textContent = msg;
        el.className = `fixed bottom-6 left-1/2 -translate-x-1/2 px-4 py-3 rounded-xl text-white shadow-lg ${ok ? "bg-emerald-600" : "bg-red-600"}`;
        el.classList.remove("hidden");
        setTimeout(() => el.classList.add("hidden"), 2200);
      }

      // ===================== NORMALIZAÇÃO / "FUZZY" LEVE =====================
      const ACCENTS = {
        a: /[àáâãäå]/g, e: /[èéêë]/g, i: /[ìíîï]/g, o: /[òóôõö]/g, u: /[ùúûü]/g, c: /[ç]/g, n: /[ñ]/g
      };
      function normalize(s) {
        if (!s) return "";
        s = String(s).toLowerCase();
        for (const [k, r] of Object.entries(ACCENTS)) s = s.replace(r, k);
        return s.replace(/[-_/]/g, " ").replace(/[^a-z0-9% ]/g, "").replace(/\s+/g, " ").trim();
      }
      function matchFuzzy(needle, hay) {
        // fuzzy simples: normaliza, aceita variações com/sem hífen e espaços
        const n = normalize(needle);
        const h = normalize(hay);
        if (!n) return true; // sem filtro → casa tudo
        if (h.includes(n)) return true;
        // tenta versão com hífen⇄espaço
        const nSwap = n.replace(/\s+/g, "-");
        const hSwap = h.replace(/\s+/g, "-");
        return hSwap.includes(nSwap);
      }

      // ===================== PARSE DE PLANILHAS =====================
      // CSV basiquinho (suporta ";" ou ",")
      function parseCSV(text) {
        const sep = text.includes(";") && !text.includes(",") ? ";" : ",";
        const lines = text.split(/\r?\n/).filter(Boolean);
        if (lines.length === 0) return [];
        const header = lines[0].split(sep).map((s) => s.trim());
        return lines.slice(1).map((ln) => {
          const cols = ln.split(sep);
          const obj = {};
          header.forEach((h, i) => (obj[h] = (cols[i] || "").trim()));
          return obj;
        });
      };
      

      // XLSX (.xlsx) → rows genéricos
      function parseXLSX(arrayBuffer) {
        const wb = XLSX.read(arrayBuffer, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]]; // primeira aba
        // tenta auto semicolon; SheetJS já entrega como objetos
        return XLSX.utils.sheet_to_json(ws, { defval: "" });
      }

      // Mapeia colunas com sinônimos comuns
      function mapFields(row) {
        const get = (keys, def = "") => {
          for (const k of keys) if (k in row && row[k] !== "") return row[k];
          return def;
        };
        return {
          nome: get(["nome_comercial","Nome Comercial","nome","Produto","produto"]),
          qtd: parseFloat(get(["quantidade","qtd","estoque","saldo"], "0").replace(",",".")) || 0,
          und: get(["unidade","un","und","u.m."], ""),
          ia: get(["ia","ingrediente_ativo","ingrediente ativo","IAs"], ""),
          pragas: get(["pragas","praga","alvos","pragas_alvo"], ""),
          registro: get(["registro","numero_registro","n_registro"], ""),
          empresa: get(["empresa","titular_registro","registrante"], ""),
          formulacao: get(["formulacao","formulação","form"], ""),
        };
      }

      // ===================== PERSISTÊNCIA =====================
      function saveAll() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state.estoque));
        localStorage.setItem(STORAGE_CAT, JSON.stringify(state.catalogo));
        localStorage.setItem(STORAGE_FILTROS, JSON.stringify(state.filtros));
      }
      function loadAll() {
        try { state.estoque = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); } catch {}
        try { state.catalogo = JSON.parse(localStorage.getItem(STORAGE_CAT) || "[]"); } catch {}
        try { state.filtros = JSON.parse(localStorage.getItem(STORAGE_FILTROS) || JSON.stringify(state.filtros)); } catch {}
      }

      // ===================== FILTROS & PROJEÇÕES =====================
      function itemMatchesFilters(item) {
        const f = state.filtros;
        // nome comercial
        if (f.nome && !matchFuzzy(f.nome, item.nome || "")) return false;
        // IA (pode ter lista separada por "," ou ";")
        if (f.ia) {
          const listIA = String(item.ia || "").split(/[,;|]/).map(s => s.trim()).filter(Boolean);
          const okIA = listIA.some((x) => matchFuzzy(f.ia, x));
          if (!okIA) return false;
        }
        // Praga (fuzzy leve mosca-branca ⇄ mosca branca)
        if (f.praga) {
          const listP = String(item.pragas || "").split(/[,;|]/).map(s => s.trim()).filter(Boolean);
          const okP = listP.some((x) => matchFuzzy(f.praga, x));
          if (!okP) return false;
        }
        // Registro válido (se marcado, exige qualquer valor não-vazio)
        if (f.somenteRegistroValido && !String(item.registro || "").trim()) return false;
        return true;
      }

      function getEstoqueFiltrado() {
        return state.estoque.filter(itemMatchesFilters);
      }
      function getForaDoEstoqueFiltrado() {
        // produtos do catálogo cujo nome comercial NÃO está no estoque
        const nomesEstoque = new Set(state.estoque.map((x) => normalize(x.nome)));
        const fora = state.catalogo.filter((c) => !nomesEstoque.has(normalize(c.nome)));
        return fora.filter(itemMatchesFilters);
      }

      // ===================== RENDER =====================
      function renderLista() {
        const grid = $("#lista");
        const vazio = $("#vazio");
        const resumo = $("#resumoContagem");

        const data = state.tab === "ESTOQUE" ? getEstoqueFiltrado() : getForaDoEstoqueFiltrado();

        grid.innerHTML = "";
        if (!data.length) {
          vazio.classList.remove("hidden");
          resumo.textContent = "0 itens";
          return;
        }
        vazio.classList.add("hidden");
        resumo.textContent = `${data.length} item(ns)`;

        data.forEach((item) => {
          const card = document.createElement("div");
          card.className = "rounded-2xl overflow-hidden border border-gray-200 bg-white hover:shadow-md transition";
          card.innerHTML = `
            <div class="p-4 space-y-2">
              <div class="flex items-start justify-between gap-3">
                <div class="font-semibold text-base leading-tight">${item.nome || "—"}</div>
                ${state.tab === "ESTOQUE" ? `<span class="text-[11px] px-2 py-1 rounded-full bg-emerald-50 border border-emerald-200 text-emerald-700">${(item.qtd ?? 0)} ${item.und || ""}</span>` : ""}
              </div>
              <div class="text-xs text-gray-500">
                <div><span class="font-medium">IA:</span> ${item.ia || "—"}</div>
                <div><span class="font-medium">Pragas:</span> ${item.pragas || "—"}</div>
                <div class="flex items-center gap-2"><span class="font-medium">Registro:</span> <span>${item.registro || "—"}</span></div>
                <div><span class="font-medium">Empresa:</span> ${item.empresa || "—"}</div>
                ${item.formulacao ? `<div><span class="font-medium">Formulação:</span> ${item.formulacao}</div>` : ""}
              </div>
              ${state.tab === "FORA" ? `<div class="pt-1"><button class="px-3 py-1.5 text-sm rounded-lg border bg-gray-50 hover:bg-gray-100">Marcar para comprar</button></div>` : ""}
            </div>`;
          grid.appendChild(card);
        });
      }

      function setActiveTab(tab) {
        state.tab = tab;
        $("#tabEstoque").className = tab === "ESTOQUE" ? "px-4 py-2 rounded-lg font-semibold bg-emerald-600 text-white" : "px-4 py-2 rounded-lg font-semibold bg-gray-100 border";
        $("#tabFora").className   = tab === "FORA"     ? "px-4 py-2 rounded-lg font-semibold bg-emerald-600 text-white" : "px-4 py-2 rounded-lg font-semibold bg-gray-100 border";
        renderLista();
      }

      // ===================== EVENTOS UI =====================
      $("#tabEstoque").onclick = () => setActiveTab("ESTOQUE");
      $("#tabFora").onclick = () => setActiveTab("FORA");

      $("#qNome").addEventListener("input", (e) => {
        state.filtros.nome = e.target.value.trim();
        renderLista();
      });
      $("#btnLimparNome").onclick = () => {
        $("#qNome").value = ""; state.filtros.nome = ""; renderLista();
      };
      $("#qIA").addEventListener("input", (e) => {
        state.filtros.ia = e.target.value.trim();
        renderLista();
      });
      $("#qPraga").addEventListener("input", (e) => {
        state.filtros.praga = e.target.value.trim();
        renderLista();
      });
      $("#btnLimparFiltros").onclick = () => {
        ["#qNome", "#qIA", "#qPraga"].forEach((id) => ($(id).value = ""));
        state.filtros = { nome: "", ia: "", praga: "", somenteRegistroValido: true };
        $("#chkSomenteComRegistro").checked = true;
        renderLista(); saveAll();
      };
      $("#chkSomenteComRegistro").onchange = (e) => {
        state.filtros.somenteRegistroValido = !!e.target.checked;
        renderLista(); saveAll();
      };

      // ===================== IMPORT/EXPORT =====================
      $("#fileEstoque").addEventListener("change", async (ev) => {
        const file = ev.target.files?.[0]; if (!file) return;
        $("#loading").classList.remove("hidden");
        let rows = [];
        try {
          if (file.name.toLowerCase().endsWith('.xlsx')) {
            const buf = await file.arrayBuffer();
            rows = parseXLSX(buf);
          } else {
            const txt = await file.text();
            rows = parseCSV(txt);
          }
        } catch (e) {
          console.error(e); toast("Falha ao ler estoque", false);
        }
        state.estoque = rows.map(mapFields).filter(x => x.nome);
        saveAll();
        $("#loading").classList.add("hidden");
        setActiveTab("ESTOQUE");
        toast(`Estoque importado: ${state.estoque.length} itens`);
      });

      $("#fileCatalogo").addEventListener("change", async (ev) => {
        const file = ev.target.files?.[0]; if (!file) return;
        $("#loading").classList.remove("hidden");
        const txt = await file.text();
        let rows = [];
        try {
          if (file.name.toLowerCase().endsWith(".json")) rows = JSON.parse(txt);
          else rows = parseCSV(txt);
        } catch (e) { toast("Falha ao ler catálogo", false); }
        // Normaliza chaves principais do catálogo
        state.catalogo = rows.map((r) => ({
          nome: r.nome_comercial || r.nome || r.Produto || r.produto || r["Nome Comercial"] || "",
          ia: r.ia || r.ingrediente_ativo || r["ingrediente ativo"] || r.IAs || "",
          pragas: r.pragas || r.praga || r.alvos || r["pragas_alvo"] || "",
          registro: r.registro || r.numero_registro || r["n_registro"] || "",
          empresa: r.empresa || r.titular_registro || r.registrante || "",
          formulacao: r.formulacao || r["formulação"] || r.form || "",
        })).filter(x => x.nome);
        saveAll();
        $("#loading").classList.add("hidden");
        toast(`Catálogo importado: ${state.catalogo.length} itens`);
        if (state.tab === "FORA") renderLista();
      });

      $("#btnExportar").onclick = () => {
        const blob = new Blob([JSON.stringify(state.filtros, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "filtros_estoque.json"; a.click();
        URL.revokeObjectURL(url);
      };

      // ===================== (Opcional) SYNC DROPBOX =====================
      // Você pode implementar aqui a chamada ao Dropbox (precisa de um pequeno backend
      // proxy para trocar refresh_token por access_token com segurança). Mantemos o
      // botão para acionamento manual e deixar o fluxo idempotente.
      $("#btnSync").onclick = async () => {
        // Busca estoque (CSV/XLSX) e catálogo (JSON/CSV) via seu backend proxy
        // Endpoints padrão (ajuste as rotas conforme seu deploy):
        const END_Estoque = "/api/estoque";   // retorna arquivo do Dropbox
        const END_Catalogo = "/api/catalogo"; // retorna JSON consolidado ou arquivo do Dropbox
        $("#loading").classList.remove("hidden");
        try {
          // 1) Estoque
          const resEst = await fetch(END_Estoque, { cache: 'no-store' });
          if (!resEst.ok) throw new Error(`Estoque HTTP ${resEst.status}`);
          const ct1 = resEst.headers.get('Content-Type') || '';
          let rowsEst = [];
          if (ct1.includes('application/json')) {
            const j = await resEst.json();
            rowsEst = Array.isArray(j) ? j : (j.rows || []);
          } else if (ct1.includes('sheet') || ct1.includes('excel') || ct1.includes('octet-stream')) {
            const buf = await resEst.arrayBuffer();
            rowsEst = parseXLSX(buf);
          } else { // assume CSV
            const txt = await resEst.text();
            rowsEst = parseCSV(txt);
          }
          state.estoque = rowsEst.map(mapFields).filter(x => x.nome);

          // 2) Catálogo
          const resCat = await fetch(END_Catalogo, { cache: 'no-store' });
          if (!resCat.ok) throw new Error(`Catalogo HTTP ${resCat.status}`);
          const ct2 = resCat.headers.get('Content-Type') || '';
          let rowsCat = [];
          if (ct2.includes('application/json')) {
            const j2 = await resCat.json();
            rowsCat = Array.isArray(j2) ? j2 : (j2.rows || []);
          } else if (ct2.includes('sheet') || ct2.includes('excel') || ct2.includes('octet-stream')) {
            const buf2 = await resCat.arrayBuffer();
            rowsCat = parseXLSX(buf2);
          } else {
            const txt2 = await resCat.text();
            rowsCat = parseCSV(txt2);
          }
          state.catalogo = rowsCat.map((r) => ({
            nome: r.nome_comercial || r.nome || r.Produto || r.produto || r["Nome Comercial"] || "",
            ia: r.ia || r.ingrediente_ativo || r["ingrediente ativo"] || r.IAs || "",
            pragas: r.pragas || r.praga || r.alvos || r["pragas_alvo"] || "",
            registro: r.registro || r.numero_registro || r["n_registro"] || "",
            empresa: r.empresa || r.titular_registro || r.registrante || "",
            formulacao: r.formulacao || r["formulação"] || r.form || "",
          })).filter(x => x.nome);

          saveAll();
          setActiveTab(state.tab); // re-render
          toast(`Sincronizado: ${state.estoque.length} em estoque, ${state.catalogo.length} no catálogo`);
        } catch (e) {
          console.error(e);
          toast("Falha na sincronização — ver backend", false);
        } finally {
          $("#loading").classList.add("hidden");
        }
      };

      // ===================== BOOT =====================
      window.addEventListener("DOMContentLoaded", () => {
        setOnlineBadge();
        loadAll();
        // hidrata filtros na UI
        $("#qNome").value = state.filtros.nome || "";
        $("#qIA").value = state.filtros.ia || "";
        $("#qPraga").value = state.filtros.praga || "";
        $("#chkSomenteComRegistro").checked = !!state.filtros.somenteRegistroValido;
        setActiveTab("ESTOQUE");
      });
    </script>

    <script>
      // Service Worker para PWA offline (usa o mesmo caminho do seu projeto atual)
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/service-worker.js");
      }
    </script>
  </body>
</html>
